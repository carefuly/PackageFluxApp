<script setup lang="ts">
import {useRoute, useRouter} from "vue-router";
import {skyMsgBox, skyMsgError, skyMsgSuccess, skyMsgWarning, skyNoticeError, skyNoticeSuccess} from "@/utils/sky";
import {getById as getByIdApp} from "@/apis/application/details";
import {listAll as fileListAll} from "@/apis/application/file";
import {
  add,
  deleteById,
  updateById,
  setFormal,
  listAll,
  getById,
} from "@/apis/application/version";
import {Delete, Edit, Position, Search, Warning} from "@element-plus/icons-vue";

const route = useRoute();
const router = useRouter();
const skyDialogRef = ref();
const formRef = ref();
const pageData = ref({
  id: null,
  searchValue: "",
  details: {
    logoUrl: "",
    appName: "",
  },
  pageParams: {
    detailId: null,
  },
  title: "Â∫îÁî®ÁâàÊú¨",
  confirmLoading: false,
  form: {
    id: null,
    versionCode: "",
    description: "",
    HBuilderUpdate: false,
    forceUpdate: false,
    formalVersion: false,
    apkUrl: "",
    wgtUrl: "",
    detail_id: null,
    remark: null,
  },
  rules: {
    versionCode: [{required: true, message: "ËØ∑ËæìÂÖ•ÁâàÊú¨Âè∑", trigger: "blur"}],
    apkUrl: [{required: true, message: "ËØ∑ËæìÂÖ•apkUrlÂú∞ÂùÄ", trigger: "blur"}],
    wgtUrl: [{required: true, message: "ËØ∑ËæìÂÖ•wgtUrlÂú∞ÂùÄ", trigger: "blur"}],
  },
  loading: false,
  total: 0,
  fileList: [],
  tableList: [],
});
const method = reactive({
  /** Ëé∑ÂèñidÂèÇÊï∞ */
  handleGetAppId: () => {
    pageData.value.id = route.path;
    return pageData.value.id.split('/')[pageData.value.id.split('/').length - 1];
  },
  /** Ëé∑ÂèñÂ∫îÁî®ËØ¶ÊÉÖ */
  handleGetByIdApp: async (id: any) => {
    try {
      const res: any = await getByIdApp(id);
      pageData.value.details = res.data;
    } catch (error) {
      skyMsgError("Êï∞ÊçÆÊü•ËØ¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
    }
  },
  /** ÈáçÁΩÆ */
  resetSearch: () => {
    method.resetSearchParams();
    method.handleListPage();
  },
  /** ÈáçÁΩÆÊêúÁ¥¢ÂèÇÊï∞ */
  resetSearchParams: () => {
    pageData.value.pageParams = {
      detailId: null,
    };
    pageData.value.pageParams.detailId = method.handleGetAppId();
  },
  /** Ê∑ªÂä† */
  handleAdd: () => {
    // ÊâìÂºÄÂºπÂá∫Ê°Ü
    skyDialogRef.value.skyOpen();
    // ÈáçÁΩÆË°®Âçï
    method.resetForm();
    // Ëé∑Âèñid
    pageData.value.form.detail_id = method.handleGetAppId();
    // Ê†áÈ¢ò
    pageData.value.title = "Ê∑ªÂä†";
    // Êñá‰ª∂Êï∞ÊçÆË°®Ê†º
    method.handleFileListAll();
  },
  /** ËÆæÁΩÆÊ≠£ÂºèÁâà */
  handleFormal: async (row: any) => {
    try {
      const res: any = await setFormal(row.id, pageData.value.pageParams.detailId);
      await method.handleListPage();
      skyMsgSuccess("ËÆæÁΩÆÊàêÂäüüåª");
    } catch (error) {
      skyMsgError(error);
    }
  },
  /** Âà†Èô§ */
  handleDelete: (row: any) => {
    const id = row.id;
    if (id === null || id === "") {
      skyMsgWarning("ËØ∑ÈÄâ‰∏≠ÈúÄË¶ÅÂà†Èô§ÁöÑÊï∞ÊçÆüåª");
      return;
    }
    skyMsgBox("ÊÇ®Á°ÆËÆ§ÈúÄË¶ÅÂà†Èô§ÂêçÁß∞[" + row.versionCode + "]‰πàÔºü")
      .then(async () => {
        try {
          await deleteById(id, pageData.value.pageParams.detailId);
          await method.handleListPage();
          skyNoticeSuccess("Âà†Èô§ÊàêÂäüüåª");
        } catch (error) {
          await method.handleListPage();
          skyNoticeError("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
        }
      })
      .catch(() => {
        skyMsgError("Â∑≤ÂèñÊ∂àüåª");
      });
  },
  /** ‰øÆÊîπ */
  handleUpdate: (row: any) => {
    // ÊâìÂºÄÂºπÂá∫Ê°Ü
    skyDialogRef.value.skyOpen();
    // Êñá‰ª∂Êï∞ÊçÆË°®Ê†º
    method.handleFileListAll();
    // ÈáçÁΩÆË°®Âçï
    method.resetForm();
    pageData.value.title = "‰øÆÊîπ";
    const id = row.id;
    if (id == null || id === "") {
      skyMsgError("ËØ∑ÈÄâ‰∏≠ÈúÄË¶Å‰øÆÊîπÁöÑÊï∞ÊçÆüåª");
    }
    // ÂõûÊòæÊï∞ÊçÆ
    method.handleEcho(id);
  },
  /** ÂõûÊòæÊï∞ÊçÆ */
  handleEcho: async (id: any) => {
    if (id === null || id === "") {
      skyMsgWarning("ËØ∑ÈÄâÊã©ÈúÄË¶Å‰øÆÊîπÁöÑÊï∞ÊçÆüåª");
      return;
    }
    try {
      const res = await getById(id, pageData.value.pageParams);
      pageData.value.form = res.data;
    } catch (error) {
      skyNoticeError("Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
    }
  },
  /** Á°ÆÂÆö  */
  handleConfirm: () => {
    if (!formRef.value) return;
    pageData.value.confirmLoading = true;
    (formRef.value).validate(async (valid: any) => {
      if (valid) {
        if (pageData.value.form.id) {
          try {
            await updateById(pageData.value.form.id, pageData.value.form);
            skyNoticeSuccess("‰øÆÊîπÊàêÂäüüåª");
            pageData.value.confirmLoading = false;
            skyDialogRef.value.skyQuickClose();
            method.resetForm();
            await method.handleListPage();
          } catch (error) {
            pageData.value.confirmLoading = false;
            skyNoticeError("‰øÆÊîπÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
          }
        } else {
          try {
            await add(pageData.value.form);
            skyNoticeSuccess("Ê∑ªÂä†ÊàêÂäüüåª");
            pageData.value.confirmLoading = false;
            skyDialogRef.value.skyQuickClose();
            method.resetForm();
            await method.handleListPage();
          } catch (error) {
            pageData.value.confirmLoading = false;
            skyNoticeError("Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
          }
        }
      } else {
        skyMsgError("È™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Â°´ÂÜôÂÜÖÂÆπüåª");
        pageData.value.confirmLoading = false;
      }
    });
  },
  /** ÂèñÊ∂à */
  handleCancel: () => {
    skyDialogRef.value.skyClose();
  },
  /** Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ */
  resetForm: () => {
    nextTick(() => {
      if (formRef.value) {
        // ÈáçÁΩÆËØ•Ë°®ÂçïÈ°πÔºåÂ∞ÜÂÖ∂ÂÄºÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄºÔºåÂπ∂ÁßªÈô§Ê†°È™åÁªìÊûú
        formRef.value.resetFields();
      }
    });
    pageData.value.form = {
      id: null,
      versionCode: "",
      description: "",
      HBuilderUpdate: false,
      forceUpdate: false,
      formalVersion: false,
      apkUrl: "",
      wgtUrl: "",
      detail_id: null,
      remark: null,
    };
  },
  /** Êï∞ÊçÆË°®Ê†º */
  handleListPage: async () => {
    try {
      pageData.value.loading = true;
      pageData.value.tableList = [];
      const res: any = await listAll(pageData.value.pageParams);
      pageData.value.tableList = res.data;
      pageData.value.loading = false;
    } catch (error) {
      skyMsgError("Êï∞ÊçÆÊü•ËØ¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
    }
  },
  /** Êñá‰ª∂Êï∞ÊçÆË°®Ê†º */
  handleFileListAll: async () => {
    try {
      pageData.value.fileList = [];
      const res: any = await fileListAll({});
      pageData.value.fileList = res.data;
    } catch (error) {
      skyMsgError("Êï∞ÊçÆÊü•ËØ¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
    }
  },
});
const filterList = computed(() => {
  if (pageData.value.searchValue) {
    return pageData.value.tableList.filter(item => item.versionCode.includes(pageData.value.searchValue));
  } else {
    return pageData.value.tableList;
  }
});
onMounted(() => {
  method.handleGetByIdApp(method.handleGetAppId());
  pageData.value.pageParams.detailId = method.handleGetAppId();
  method.handleListPage();
});
</script>

<template>
  <div class="sky-flex">
    <SkyCard>
      <!-- ËØ¶ÊÉÖÊìç‰Ωú -->
      <el-row :gutter="10" style="display: flex; justify-content: space-between">
        <div style="display: flex; align-items: center;">
          <el-col :span="1.5">
            <el-tooltip content="ËøîÂõû">
              <el-button size="small" type="primary" icon="ArrowLeftBold" circle plain
                         @click="router.push('/application')"></el-button>
            </el-tooltip>
          </el-col>
          <el-col :span="1.5">
            <img style="width: 25px; height: 25px" :src="pageData.details.logoUrl" :alt="pageData.details.appName">
          </el-col>
          <el-col :span="1.5">
            {{ pageData.details.appName }}
            |
            <span style="font-size: 13px">ÁâàÊú¨ÁÆ°ÁêÜ</span>
          </el-col>
        </div>
        <div>
          <el-col :span="1.5">
            <el-button type="primary" icon="plus" plain @click="method.handleAdd()">Êñ∞Â¢ûÁâàÊú¨</el-button>
            <el-button type="danger" icon="refresh" plain @click="method.resetSearch">ÈáçÁΩÆ</el-button>
          </el-col>
        </div>
        <el-col :span="1.5">
          <el-input
            style="width: 270px"
            placeholder="ËØ∑ËæìÂÖ•Â∫îÁî®ÁâàÊú¨Âè∑„Äê‰æãÂ¶ÇÔºö2.2.8„Äë"
            :prefix-icon="Search"
            v-model="pageData.searchValue"
            clearable
          ></el-input>
        </el-col>
      </el-row>
      <br/>
      <!-- Â∫îÁî®ÂàóË°® -->
      <el-timeline v-if="filterList.length > 0">
        <el-timeline-item
          v-for="item in filterList"
          :key="item.id"
          :type="item.formalVersion ? 'success': 'info'"
        >
          <!-- ÁâàÊú¨Êìç‰Ωú -->
          <div class="title">
            <el-text class="mr-2" size="large" type="primary">{{ item.versionCode }}</el-text>
            <!-- ËÆæ‰∏∫Ê≠£ÂºèÁâà -->
            <el-popconfirm
              v-if="!item.formalVersion"
              width="220"
              title="ÊòØÂê¶Â∞ÜÂΩìÂâçÁâàÊú¨ËÆæ‰∏∫Ê≠£ÂºèÁâà"
              type="warning"
              ok-text="Á°ÆËÆ§"
              cancel-text="ÂèñÊ∂à"
              @confirm="method.handleFormal(item)"
            >
              <template #reference>
                <el-icon class="mr-2">
                  <Position/>
                </el-icon>
              </template>
            </el-popconfirm>
            <!-- ÁºñËæë -->
            <el-tooltip content="ÁºñËæë">
              <el-icon class="mr-2" @click="method.handleUpdate(item)">
                <Edit/>
              </el-icon>
            </el-tooltip>
            <!-- Âà†Èô§ -->
            <el-popconfirm
              v-if="!item.formalVersion"
              title="ÊòØÂê¶Âà†Èô§ÂΩìÂâçÁâàÊú¨"
              width="180"
              @confirm="method.handleDelete(item)"
            >
              <template #reference>
                <el-icon>
                  <Delete/>
                </el-icon>
              </template>
            </el-popconfirm>
          </div>
          <!-- ÁâàÊú¨‰ø°ÊÅØ -->
          <div class="mt-2 mb-2">
            <el-text
              v-if="item.description"
              class="mx-1"
              v-for="desc in item.description.split('\n')"
              :key="desc"
            >
              <el-tooltip :content="desc">
                {{ desc }}
              </el-tooltip>
              <br/>
            </el-text>
          </div>
          <el-text class="mx-1" type="success">
            Apk‰∏ãËΩΩÂú∞ÂùÄ:
            <el-text class="mx-1">{{ item.apkUrl }}</el-text>
          </el-text>
          <div class="h-0.5em"></div>
          <el-text class="mx-1" type="warning">
            Wgt‰∏ãËΩΩÂú∞ÂùÄ:
            <el-text class="mx-1">{{ item.wgtUrl }}</el-text>
          </el-text>
          <div class="h-0.5em"></div>
          <el-tag v-if="item.HBuilderUpdate" class="mr-2" type="primary">HBuilderXÂº∫Âà∂Êõ¥Êñ∞</el-tag>
          <el-tag v-if="item.forceUpdate" type="success">Âº∫Âà∂Êõ¥Êñ∞</el-tag>
          <div class="h-0.5em"></div>
          <el-tag v-if="item.formalVersion" type="danger">Ê≠£ÂºèÁâàÊú¨</el-tag>
          <div class="h-0.5em"></div>
          <el-text class="mx-1" type="danger">
            ‰∏äÊ¨°Êõ¥Êñ∞Êó∂Èó¥Ôºö
            <el-text class="mx-1">{{ item.updateTime }}</el-text>
          </el-text>
        </el-timeline-item>
      </el-timeline>
      <div v-else class="message center">
        <h1>ÁâàÊú¨‰∏∫Á©∫</h1>
        <p>ËØ∑ÈÄöËøá‰∏≠‰∏äËßíÁöÑÊñ∞Â¢ûÊåâÈíÆÊ∑ªÂä†ÁâàÊú¨</p>
      </div>
      <!-- Ê∑ªÂä† OR ‰øÆÊîπ -->
      <SkyDialog
        ref="skyDialogRef"
        :title="pageData.title"
        @skyConfirm="method.handleConfirm"
        @skyCancel="method.handleCancel"
        :loading="pageData.confirmLoading"
        :width="750"
        :height="450"
      >
        <template #content>
          <el-form ref="formRef" :model="pageData.form" :rules="pageData.rules" label-width="auto">
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="Â∫îÁî®ÁâàÊú¨Âè∑" prop="versionCode">
                  <el-input v-model="pageData.form.versionCode"
                            placeholder="ËØ∑ËæìÂÖ•Â∫îÁî®ÁâàÊú¨Âè∑Ôºå‰æãÂ¶ÇÔºö2.2.8" :disabled="pageData.form.id !== null" clearable/>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="Êõ¥Êñ∞ËØ¥Êòé" prop="description">
                  <el-input v-model="pageData.form.description" :rows="3" type="textarea" placeholder="‰æãÂ¶ÇÔºö1.‰øÆÂ§ç‰∫ÜÈÉ®ÂàÜbug
          2.Â¢ûÂä†‰∫ÜÊüêÊüêÂäüËÉΩ" clearable/>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="HBuilderXÊòØÂê¶Êõ¥Êñ∞">
                  <template #label>
                    <div style="display: flex; align-items: center">
                      <span style="margin-right: 5px">HBuilderXÊòØÂê¶Êõ¥Êñ∞</span>
                      <el-tooltip>
                        <template #content>
                          ÊòØÁöÑËØùËØ•ÁâàÊú¨Âè™‰ºöËøõË°åapkÂÖ®ÈáèÊõ¥Êñ∞
                        </template>
                        <el-icon>
                          <Warning/>
                        </el-icon>
                      </el-tooltip>
                    </div>
                  </template>
                  <el-switch v-model="pageData.form.HBuilderUpdate" inline-prompt active-text="ÊòØ" inactive-text="Âê¶"/>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="ÊòØÂê¶Âº∫Âà∂Êõ¥Êñ∞">
                  <el-switch v-model="pageData.form.forceUpdate" inline-prompt active-text="ÊòØ" inactive-text="Âê¶"/>
                  <template #label>
                    <div style="display: flex; align-items: center">
                      <span style="margin-right: 5px">ÊòØÂê¶Âº∫Âà∂Êõ¥Êñ∞</span>
                      <el-tooltip>
                        <template #content>
                          Âê¶ÁöÑËØùÊõ¥Êñ∞ÂºπÁ™óÂ∫ïÈÉ®‰ºöÊúâ[ÊöÇ‰∏çÊõ¥Êñ∞]ÊåâÈíÆ
                        </template>
                        <el-icon>
                          <Warning/>
                        </el-icon>
                      </el-tooltip>
                    </div>
                  </template>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="apk‰∏ãËΩΩÂú∞ÂùÄ" prop="apkUrl">
                  <el-select
                    v-model="pageData.form.apkUrl"
                    filterable
                    allow-create
                    default-first-option
                    :reserve-keyword="false"
                    placeholder="ËØ∑ËæìÂÖ•ÊàñÈÄâÊã©apk‰∏ãËΩΩÂú∞ÂùÄ"
                    clearable
                  >
                    <el-option
                      v-for="item in pageData.fileList"
                      :key="item.id"
                      :label="item.name + `.${item.suffix}`"
                      :value="item.url"
                    />
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="wgt‰∏ãËΩΩÂú∞ÂùÄ" prop="wgtUrl">
                  <el-select
                    v-model="pageData.form.wgtUrl"
                    filterable
                    allow-create
                    default-first-option
                    :reserve-keyword="false"
                    placeholder="ËØ∑ËæìÂÖ•ÊàñÈÄâÊã©wgt‰∏ãËΩΩÂú∞ÂùÄ"
                    clearable
                  >
                    <el-option
                      v-for="item in pageData.fileList"
                      :key="item.id"
                      :label="item.name + `.${item.suffix}`"
                      :value="item.url"
                    />
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :xs="{ span: 24 }" :sm="{ span: 24 }">
                <el-form-item label="Â§áÊ≥®" prop="remark">
                  <el-input v-model="pageData.form.remark" :rows="3" type="textarea" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®"/>
                </el-form-item>
              </el-col>
            </el-row>
          </el-form>
        </template>
      </SkyDialog>
    </SkyCard>
  </div>
</template>

<style scoped lang="scss">
.message {
  height: 600px;
  flex-direction: column;
}

.center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.title {
  display: flex;
  align-items: center;
}

.url {
  margin: 10px 0;
}
</style>
